---
lab:
  title: Azure Machine Learning デザイナーを使用する
ms.openlocfilehash: ce03f54e5762e66363608b88fd86ec1de5795a33
ms.sourcegitcommit: 48bc4227570b0817702d195aa06fa4dabe1bbdd7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2022
ms.locfileid: "146733078"
---
# <a name="use-azure-machine-learning-designer"></a>Azure Machine Learning デザイナーを使用する

Azure Machine Learning "*デザイナー*" は、ワークフロー、またはデータ インジェスト、変換、モデル トレーニング コンポーネントの "*パイプライン*" を定義して、機械学習モデルを作成できるドラッグ アンド ドロップ環境を提供します。 その後、このパイプラインを、クライアント アプリケーションが"*推論* " (新しいデータから予測を生成する) に使用できる Web サービスとして公開できます。

## <a name="before-you-start"></a>開始前の準備

まだ行っていない場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を完了して、Azure Machine Learning ワークスペースとコンピューティング インスタンスを作成し、この演習に必要なノートブックのクローンを作成してください。

## <a name="configure-compute-resources"></a>コンピューティング リソースを構成する

Azure Machine Learning デザイナーを使用するには、モデル トレーニング実験を実行するための計算が必要です。

1. Azure サブスクリプションに関連付けられた Microsoft の資格情報を使用して [Azure Machine Learning スタジオ](https://ml.azure.com?azure-portal=true) にサインインし、Azure Machine Learning ワークスペースを選択します。
2. Azure Machine Learning スタジオで、 **[コンピューティング]** ページを表示し、まだ実行されていない場合は、 **[コンピューティング インスタンス]** タブでコンピューティング インスタンスを開始します。 このコンピューティング インスタンスを使用して、トレーニングされたモデルをテストします。
3. コンピューティング インスタンスが開始されている間に、 **[コンピューティング クラスター]** タブに切り替えます。既存のコンピューティング クラスターをまだお持ちではない場合は、次の設定で新しいコンピューティング クラスターを追加します。 このクラスターを使用して、トレーニング パイプラインを実行します。
    - **リージョン**: "*ワークスペースと同じリージョン*"
    - **[バーチャル マシンの優先度]**:専用
    - **[仮想マシンのタイプ]**:CPU
    - **[仮想マシンのサイズ]**: Standard_DS11_v2
    - **[コンピューティング名]**: "*一意の名前を入力します*"
    - **[ノードの最小数]**: 0
    - **[ノードの最大数]**:2
    - **[スケール ダウンする前のアイドル時間 (秒)]**:120
    - **[Enable SSH access]\(SSH アクセスの有効化\)**: 未選択

## <a name="review-the-training-dataset"></a>トレーニング データセットを確認する

これで、トレーニング パイプラインを実行するためのコンピューティング・リソースが得られたので、モデルをトレーニングするためのデータが必要になります。

1. Azure Machine Learning スタジオで、 **[データ]** ページを表示します。 データセットは、Azure ML 内で使用する予定の特定のデータ ファイルまたはテーブルを表します。
2. 以前に **糖尿病データセット** データセットを作成した場合は、それを開きます。 それ以外の場合は、次の設定を使用して Web ファイルから新しいデータセットを作成し、それを開きます。
    * **[基本情報]**:
        * **Web URL**: https://aka.ms/diabetes-data
        * **名前**: 糖尿病データセット
        * **データセットの種類**:表形式
        * **説明**:糖尿病データ
    * **設定とプレビュー**:
        * **[ファイル形式]**: 区切り記号付き
        * **[区切り記号]**: コンマ
        * **[エンコード]**: UTF-8
        * **列見出し**:最初のファイルのヘッダーを使用する
        * **[行のスキップ]**: なし
    * **[スキーマ]**:
        * **[パス]** 以外のすべての列を含める
        * 自動的に検出された型を確認する
    * **[詳細の確認]**:
        * 作成後にデータセットをプロファイリングしない

4. **[探索]** ページを表示して、データのサンプルを表示します。 このデータは、糖尿病の検査を受けた患者の詳細を表しています。臨床的な測定値に基づいて、患者が糖尿病で陽性と判定される可能性を予測するモデルをトレーニングするために使用します。

## <a name="create-a-designer-pipeline"></a>デザイナー パイプラインを作成する

デザイナーを使用するには、まずパイプラインを作成し、使用するデータセットを追加する必要があります。

1. Azure Machine Learning スタジオで、 **[デザイナー]** ページを表示し、新しいパイプラインを作成します。
2. 既定のパイプライン名 (**Pipeline-Created-on-* date***) を **Visual Diabetes Training** に変更するには、右側の **&#9881;** アイコンをクリックして **[設定]** ペインを開きます。
3. パイプラインを実行するコンピューティング先を指定する必要があることに注意してください。 **[設定]** ペインで、 **[コンピューティングの種類の選択]** をクリックし、[コンピューティング クラスター] を選択し、[Azure ML コンピューティング クラスターの選択] をクリックしてコンピューター クラスターを選択し、[設定] を閉じます。
4. デザイナーの左側で、 **[データ]** タブを選択し、**糖尿病データセット** データセットをキャンバスにドラッグします。
5. キャンバス上の **糖尿病データセット** コンポーネントを選択します。 次に、それを右クリックし、 **[データのプレビュー]** を選択します。
6. DataOutput ペインで、 **[プロファイル]** タブを選択します。
7. データのスキーマを確認します。さまざまな列の分布がヒストグラムとして表示されることに注意してください。 次に、視覚化を閉じます。

## <a name="add-transformations"></a>変換の追加

モデルをトレーニングする前に、通常はいくつかの前処理変換をデータに適用する必要があります。

1. 左側のペインで、 **[コンポーネント]** タブを選択します。ここには、モデル トレーニングの前にデータを変換するために使用できるさまざまなコンポーネントが含まれています。 ペインの上部にあるコンポーネントを検索できます。
2. **[Normalize Data]\(データの正規化\)** コンポーネントを検索し、**糖尿病データセット** コンポーネントの下のキャンバスにドラッグします。 次に、**糖尿病データセット** コンポーネントからの出力を **[Normalize Data]\(データの正規化\)** コンポーネントの入力に接続します。
3. **[Normalize Data]\(データの正規化\)** コンポーネントを選択し、その設定を表示して、変換の方法と変換する列を指定する必要があることに注目します。 その後、変換を **ZScore** のままにして、列を編集して次の列名を含めます。
    * PlasmaGlucose
    * DiastolicBloodPressure
    * TricepsThickness
    * SerumInsulin
    * BMI
    * DiabetesPedigree

    **注**: 数値列を正規化して同じスケールにし、大きい値を含む列がモデルのトレーニングに大きな影響を及ぼさないようにしています。 通常、このような前処理変換の全体を適用して、トレーニング用のデータを準備しますが、この演習では簡単な作業を行います。

4. これで、トレーニングと検証のためにデータを個別のデータセットに分割する準備ができました。 左側のペインで、 **[Split Data]\(データの分割\)** コンポーネントを検索し、 **[Normalize Data]\(データの正規化\)** コンポーネントの下のキャンバスにドラッグします。 次に、 **[Normalize Data]\(データの正規化\)** コンポーネントの "*変換されたデータセット*" (左側) の出力を、 **[Split Data]\(データの分割\)** コンポーネントの入力に接続します。
5. **[Split Data]\(データの分割\)** コンポーネントを選択し、その設定を次のように構成します。
    * **分割モード** 行の分割
    * **最初の出力データセット内の行の割合**:0.7
    * **[ランダム シード]**: 123
    * **[Stratified split](層化分割)**: False

## <a name="add-model-training-components"></a>モデル トレーニング コンポーネントを追加する

データを準備し、トレーニング データセットと検証データセットに分割したら、パイプラインを構成してモデルをトレーニングおよび評価する準備が整います。

1. **[モデルのトレーニング]** コンポーネントを検索し、 **[Split Data]\(データの分割\)** コンポーネントの下のキャンバスにドラッグします。 次に、 **[Split Data]\(データの分割\)** コンポーネントの "*結果データセット 1*" (左側) の出力を **[モデルのトレーニング]** コンポーネントの "*データセット*" (右側) の入力に接続します。
2. トレーニングするモデルでは **Diabetic** の値が予測されるため、 **[モデルのトレーニング]** コンポーネントを選択し、**ラベル列** を **糖尿病** に設定するように設定を変更します (大文字と小文字の区別とスペルは正確に一致させます)。
3. モデルが予測する **糖尿病** ラベルはバイナリ列 (糖尿病患者の場合は 1、そうでない患者の場合は 0) であるため、"*分類*" アルゴリズムを使用してモデルをトレーニングする必要があります。 **[Two-Class Logistic Regression]\(2 クラス ロジスティック回帰\)** コンポーネントを検索し、キャンバス上の **[Split Data]\(データの分割\)** コンポーネントの左側かつ **[モデルトのレーニング]** コンポーネントの上にドラッグ アンド ドロップします。 次に、その出力を、 **[モデルのトレーニング]** コンポーネントの **未トレーニング モデル** (左側) の入力に接続します。
4. トレーニング済みモデルをテストするには、元のデータを分割するときに元に戻した検証データセットをスコアリングするために使用する必要があります。 **[Score Model]\(モデルのスコア付け\)** コンポーネントを検索し、キャンバスの **[モデルのトレーニング]** コンポーネントの下にドラッグ アンド ドロップします。 次に、 **[モデルのトレーニング]** コンポーネントの出力を、 **[Score Model]\(モデルのスコア付け\)** コンポーネントの **トレーニング済みモデル** (左側) の入力に接続します。 **[Split Data]\(データの分割\)** コンポーネントの **結果データセット 2** (右側) の出力を、 **[Score Model]\(モデルのスコア付け\)** コンポーネントの **データセット** (右側) の入力にドラッグします。
5. モデルのパフォーマンスを評価するには、検証データセットのスコアリングによって生成されるメトリックを調べる必要があります。 **[Evaluate Model]\(モデルの評価\)** コンポーネントを検索して、キャンバス上の **[Score Model]\(モデルのスコア付け\)** コンポーネントの下にドラッグし、 **[Score Model]\(モデルのスコア付け\)** コンポーネントの出力を **[Evaluate Model]\(モデルの評価\)** コンポーネントの **データセットのスコアリング** (左) の入力に接続します。

## <a name="run-the-training-pipeline"></a>トレーニング パイプラインを実行する

データ フロー ステップを定義したら、トレーニング パイプラインを実行してモデルをトレーニングする準備が整います。

1. パイプラインが以下のようになっていることを確認します。

    ![ビジュアル トレーニング パイプライン](images/visual-training.jpg)

2. 右上の **[送信]** をクリックします。 次に、ダイアログが表示されたら、**mslearn-designer-train-diabetes** という名前の新しい実験を作成し、実行します。  これにより、コンピューティング クラスターが初期化され、パイプラインが実行されます。実行には 10 分以上かかる場合があります。 デザイン キャンバスの右上で、パイプライン実行の状態を確認できます。

    > **ヒント**: **GraphDatasetNotFound** エラーが発生した場合は、データセットを選択し、その [プロパティ] ペインで **バージョン** を変更して ([常に最新のものを使用する] か [1] に切り替えられます)、パイプラインを再び実行します。
    >
    > 実行中は、 **[パイプライン]** および **[実験]** ページで作成されたパイプラインと実験を表示できます。 完了したら、 **[デザイナー]** ページの **Visual Diabetes Training** パイプラインに切り替えます。

3. **[Normalize Data]\(データの正規化\)** コンポーネントが完了したら、それを選択し、 **[設定]** ペインの **[出力とログ]** タブを開き、 **[Transformed dataset]\(変換済みデータセット\)** セクションの **[Data outputs]\(データ出力\)** で、 **[データのプレビュー]** アイコンをクリックします。変換された列の統計情報と分布の視覚化が表示されていることに注目してください。
4. **[Normalize Data]\(データの正規化\)** の視覚化を閉じ、残りのコンポーネントが完了するまで待ちます。 次に、 **[Evaluate Model]\(モデルの評価\)** コンポーネントの出力を視覚化して、モデルのパフォーマンス メトリックを確認します。

    **注**: このモデルのパフォーマンスは、最小限の特徴エンジニアリングと前処理のみを実行したため、パフォーマンスが非常に高いとは言えません。 いくつかの異なる分類アルゴリズムを試して結果を比較することができます ( **[Split Data]\(データの分割\)** コンポーネントの出力を複数の **[モデルのトレーニング]** および **[Score Model]\(モデルのスコア付け\)** コンポーネントに接続し、2 番目にスコア付けしたモデルを **[Evaluate Model]\(モデルの評価\)** コンポーネントに接続して並べて比較できます)。 演習のポイントは、完璧なモデルをトレーニングすることではなく、単にデザイナーのインターフェイスを紹介することです。

## <a name="create-an-inference-pipeline"></a>推論パイプラインを作成する

"*トレーニング パイプライン*" を使用してモデルをトレーニングしたので、トレーニング済みモデルを使用して新しいデータのラベルを予測する "*推論パイプライン*" を作成できます。

1. **[ジョブ]** タブで、完了したパイプラインに移動します。 
2. **[Create inference pipeline]\(推論パイプラインの作成\)** を選択し、 **[real-time inference pipeline]\(リアルタイム推論パイプライン\)** をクリックします。 数秒後に、**Visual Diabetes Training - リアルタイム推論** という名前のパイプラインの新しいバージョンが開きます。
3. 新しいパイプラインの名前を **Predict Diabetes** に変更し、新しいパイプラインを確認します。 正規化の変換とトレーニング済みモデルはこのパイプラインにカプセル化されているため、新しいデータ値の正規化にはトレーニング データからの統計情報が使用され、新しいデータのスコア付けにはトレーニング済みモデルが使用されます。
4. 推論パイプラインでは、新しいデータが元のトレーニング データのスキーマと一致するものと仮定されるため、トレーニング パイプラインの **糖尿病データセット** データセットが含まれていることにご注意ください。 ただし、この入力データには、モデルによって予測される **Diabetic** ラベルが含まれています。これは、糖尿病予測がまだ行われていない新しい患者データに含めるには非直感的です。
5. この **糖尿病データセット** データセットを推論パイプラインから削除し、 **[Enter Data Manually]\(データの手動入力\)** コンポーネントに置き換えます。これにより、**Web サービス入力** と同じ **[変換を適用]** コンポーネントの **データセット** 入力に接続します。 次に、 **[Enter Data Manually]\(データの手動入力\)** コンポーネントの設定を変更し、3 人の新しい患者観察用ラベルのない特徴値を含む次の CSV 入力を使用します。

```CSV
PatientID,Pregnancies,PlasmaGlucose,DiastolicBloodPressure,TricepsThickness,SerumInsulin,BMI,DiabetesPedigree,Age
1882185,9,104,51,7,24,27.36983156,1.350472047,43
1662484,6,73,61,35,24,18.74367404,1.074147566,75
1228510,4,115,50,29,243,34.69215364,0.741159926,59
```

5. 推論パイプラインには **[Evaluate Mode]\(モデルの評価\)** コンポーネントが含まれていますが、このコンポーネントは、新しいデータから予測するときには役に立たないため削除します。
6. **[Score Model]\(モデルのスコア付け\)** コンポーネントからの出力には、すべての入力の特徴に加え、予測ラベルと確率スコアが含まれています。 出力を予測と確率のみに制限するには、 **[Score Model]\(モデルのスコア付け\)** コンポーネントと **[Web Service Output]\(Web サービス出力\)** の間の接続を削除し、 **[Execute Python Script]\(Python スクリプトの実行\)** コンポーネントを追加します。 **[Score Model]\(モデルのスコア付け\)** コンポーネントからの出力を、 **[Execute Python Script]\(Python スクリプトの実行\)** の **データセット 1** (左端) の入力に接続し、 **[Execute Python Script]\(Python スクリプトの実行\)** コンポーネントの出力を **[Web Service Output]\(Web サービス出力\)** に接続します。 次に、次のコードを使用するように **[Execute Python Script]\(Python スクリプトの実行\)** コンポーネントの設定を変更します (既存のコードをすべて置き換えます)。

```Python
import pandas as pd

def azureml_main(dataframe1 = None, dataframe2 = None):

    scored_results = dataframe1[['PatientID', 'Scored Labels', 'Scored Probabilities']]
    scored_results.rename(columns={'Scored Labels':'DiabetesPrediction',
                                    'Scored Probabilities':'Probability'},
                            inplace=True)
    return scored_results
```
> **注**: **[Execute Python Script]\(Python スクリプトの実行\)** コンポーネントにコードを貼り付けた後、コードが上記のコードのようになっていることを確認します。 Python ではインデントが重要であり、インデントが正しくコピーされていないとコンポーネントは失敗します。 

7. パイプラインが以下のようになっていることを確認します。

    ![ビジュアル推論パイプライン](images/visual-inference.jpg)

9. トレーニングに使用したコンピューティング クラスターで、**mslearn-designer-predict-diabetes** という名前の新しい実験としてパイプラインを送信します。 これには時間がかかる場合があります。

## <a name="deploy-the-inference-pipeline-as-a-web-service"></a>Web サービスとして推論パイプラインをデプロイする

これで、リアルタイム推論のための推論パイプラインが作成され、クライアント アプリケーションが使用する Web サービスとしてデプロイできます。

> **注**:この演習では、Azure コンテナー インスタンス (ACI) に Web サービスをデプロイします。 この種類のコンピューティングは、動的に作成され、開発とテストに役立ちます。 運用環境では、"*推論クラスター*" を作成する必要があります。これにより、スケーラビリティとセキュリティを向上させる Azure Kubernetes Service (AKS) クラスターが提供されます。

1. **糖尿病の予測** 推論パイプラインの実行がまだ完了していない場合は、完了を待ちます。 次に、 **[Execute Python Script]\(Python スクリプトの実行\)** コンポーネントの **結果データセット** 出力を視覚化して、入力データ内の 3 人の患者観察の予測ラベルと確率を確認します。
2. 右上の **[デプロイ]** をクリックし、次の設定を使用して新しいリアルタイム エンドポイントをデプロイします。
    -  **名前**: designer-predict-diabetes
    -  **説明**: 糖尿病の予測。
    - **[コンピューティングの種類]**: Azure コンテナー インスタンス
3. Web サービスがデプロイされるまで待ちます。これには数分かかることがあります。 デプロイの状態は、デザイナー インターフェイスの左上に表示されます。

## <a name="test-the-web-service"></a>Web サービスをテストする

これで、クライアント アプリケーションからデプロイ済みのサービスをテストできます。この場合、ノートブックを使用します。

1. **[エンドポイント]** ページで、**designer-predict-diabetes** のリアルタイム エンドポイントを開きます。
2. **designer-predict-diabetes** エンドポイントが開いたら、 **[使用]** タブで、**REST** エンドポイントと **主キー** の値をメモします。
3. ブラウザーに **designer-predict-diabetes** サービス ページの **[使用]** ページが開いた状態で、新しいブラウザー タブを開き、Azure Machine Learning スタジオの 2 番目のインスタンスを開きます。 次に、新規タブで **[ノートブック]** ページを表示します。
4. **ノートブック** ページの **[マイ ファイル]** で、ノートブック リポジトリを複製した **/users/*your-user-name*/mslearn-dp100** フォルダーを参照し、**デザイナー予測を取得する** ノートブックを開きます。
5. ノートブックが開いたら、前に作成したコンピューティング インスタンスが **[コンピューティング]** ボックスで選択されていること、およびその状態が **[実行中]** であることを確認します。
6. ノートブックで、**ENDPOINT** および **PRIMARY_KEY** のプレースホルダーをサービスの値に置き換えます。これは、エンドポイントのページの **[使用]** タブからコピーできます。
7. コード セルを実行し、Web サービスから返された出力を表示します。

## <a name="clean-up"></a>クリーンアップ

作成した Web サービスは "*Azure コンテナー インスタンス*" にホストされます。 それ以上実験する予定がない場合は、不要な Azure の使用が発生するのを避けるために、エンドポイントを削除する必要があります。 また、再び必要になるまでコンピューティング インスタンスを停止する必要もあります。

1. Azure Machine Learning スタジオの **[エンドポイント]** タブで、**designer-predict-diabetes** エンドポイントを選択します。 次に、 **[削除]** (&#128465;) ボタンをクリックし、エンドポイントの削除を確認します。
2. Azure Machine Learning での作業が終わったら、 **[コンピューティング インスタンス]** タブを選択し、 **[停止]** をクリックしてシャットダウンします。

> **注**: コンピューティングを停止すると、サブスクリプションがコンピューティング リソースに対して課金されなくなります。 ただし、サブスクリプションに Azure Machine Learning ワークスペースが存在する限り、データ ストレージに対して少額が課金されます。 Azure Machine Learning の探索を完了したら、Azure Machine Learning ワークスペースとそれに関連付けられたリソースを削除できます。 ただし、このシリーズの他のラボを修了する場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を繰り返して、ワークスペースを作成し、環境を準備する必要があります。
