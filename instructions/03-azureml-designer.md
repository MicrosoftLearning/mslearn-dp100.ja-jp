---
lab:
  title: Azure Machine Learning デザイナーを使用する
ms.openlocfilehash: 3bfe1bf2e119c295ad3931c569e1f09b41bb2174
ms.sourcegitcommit: 38540a481d1dfa9bab570777b72e3cf9b6ee6da7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/16/2021
ms.locfileid: "137894495"
---
# <a name="use-azure-machine-learning-designer"></a>Azure Machine Learning デザイナーを使用する

Azure Machine Learning "*デザイナー*" は、ワークフロー、またはデータ インジェスト、変換、モデル トレーニング モジュールの "*パイプライン*" を定義して、機械学習モデルを作成できるドラッグ アンド ドロップ環境を提供します。 その後、このパイプラインを、クライアント アプリケーションが"*推論* " (新しいデータから予測を生成する) に使用できる Web サービスとして公開できます。

## <a name="before-you-start"></a>開始前の準備

まだ行っていない場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を完了して、Azure Machine Learning ワークスペースとコンピューティング インスタンスを作成し、この演習に必要なノートブックのクローンを作成してください。

## <a name="configure-compute-resources"></a>コンピューティング リソースを構成する

Azure Machine Learning デザイナーを使用するには、モデル トレーニング実験を実行するための計算が必要です。

1. Azure サブスクリプションに関連付けられた Microsoft の資格情報を使用して [Azure Machine Learning スタジオ](https://ml.azure.com?azure-portal=true) にサインインし、Azure Machine Learning ワークスペースを選択します。
2. Azure Machine Learning スタジオで、 **[コンピューティング]** ページを表示し、まだ実行されていない場合は、 **[コンピューティング インスタンス]** タブでコンピューティング インスタンスを開始します。 このコンピューティング インスタンスを使用して、トレーニングされたモデルをテストします。
3. コンピューティング インスタンスが開始されている間に、 **[コンピューティング クラスター]** タブに切り替えます。既存のコンピューティング クラスターをまだお持ちではない場合は、次の設定で新しいコンピューティング クラスターを追加します。 このクラスターを使用して、トレーニング パイプラインを実行します。
    - **リージョン**: "*ワークスペースと同じリージョン*"
    - **[バーチャル マシンの優先度]**:専用
    - **[仮想マシンのタイプ]**:CPU
    - **[仮想マシンのサイズ]**: Standard_DS11_v2
    - **[コンピューティング名]**: "*一意の名前を入力します*"
    - **[ノードの最小数]**: 0
    - **[ノードの最大数]**:2
    - **[スケール ダウンする前のアイドル時間 (秒)]**:120
    - **[Enable SSH access]\(SSH アクセスの有効化\)**: 未選択

## <a name="review-the-training-dataset"></a>トレーニング データセットを確認する

これで、トレーニング パイプラインを実行するためのコンピューティング・リソースが得られたので、モデルをトレーニングするためのデータが必要になります。

1. Azure Machine Learning スタジオで、 **[データセット]** ページを表示します。 データセットは、Azure ML 内で使用する予定の特定のデータ ファイルまたはテーブルを表します。
2. 以前に **糖尿病データセット** データセットを作成した場合は、それを開きます。 それ以外の場合は、次の設定を使用して Web ファイルから新しいデータセットを作成し、それを開きます。
    * **[基本情報]**:
        * **Web URL**: https://aka.ms/diabetes-data
        * **名前**: 糖尿病データセット
        * **データセットの種類**:表形式
        * **説明**:糖尿病データ
    * **設定とプレビュー**:
        * **[ファイル形式]**: 区切り記号付き
        * **[区切り記号]**: コンマ
        * **[エンコード]**: UTF-8
        * **列見出し**:最初のファイルのヘッダーを使用する
        * **[行のスキップ]**: なし
    * **[スキーマ]**:
        * **[パス]** 以外のすべての列を含める
        * 自動的に検出された型を確認する
    * **[詳細の確認]**:
        * 作成後にデータセットをプロファイリングしない

4. **[探索]** ページを表示して、データのサンプルを表示します。 このデータは、糖尿病の検査を受けた患者の詳細を表しています。臨床的な測定値に基づいて、患者が糖尿病で陽性と判定される可能性を予測するモデルをトレーニングするために使用します。

## <a name="create-a-designer-pipeline"></a>デザイナー パイプラインを作成する

デザイナーを使用するには、まずパイプラインを作成し、使用するデータセットを追加する必要があります。

1. Azure Machine Learning スタジオで、 **[デザイナー]** ページを表示し、新しいパイプラインを作成します。
2. 既定の名前をクリックして (またはパイプライン名の横にある **&#9881;** アイコンをクリックして)、既定のパイプライン名 (**Pipeline-Created-on-* date***) を **Visual Diabetes Training** に変更します。
3. パイプラインを実行するコンピューティング先を指定する必要があることに注意してください。 **[設定]** ウィンドウで、 **[コンピューティング先を選択]** をクリックし、コンピューティング クラスターを選択します。
4. デザイナーの左側で、 **[データセット]** セクションを展開し、**糖尿病データセット** データセットをキャンバスにドラッグします。
5. キャンバス上の **糖尿病データセット** モジュールを選択します。 次に、それを右クリックし、 **[データのプレビュー]** を選択します。
6. DatasetOutput ペインで、 **[プロファイル]** タブを選択します。
7. データのスキーマを確認します。さまざまな列の分布がヒストグラムとして表示されることに注意してください。 次に、視覚化を閉じます。

## <a name="add-transformations"></a>変換の追加

モデルをトレーニングする前に、通常はいくつかの前処理変換をデータに適用する必要があります。

1. 左側のペインで、**[データ変換]** セクションを展開します。ここには、モデル トレーニングの前にデータを変換するために使用できるさまざまなモジュールが含まれています。
2. **データの正規化** モジュールを、**糖尿病データセット** モジュールの下のキャンバスにドラッグします。 次に、**糖尿病データセット** モジュールからの出力を **データの正規化** モジュールの入力に接続します。
3. **[データの正規化]** モジュールを選択し、その設定を表示して、変換の方法と変換する列を指定する必要があることに注目します。 その後、変換を **ZScore** のままにして、列を編集して次の列名を含めます。
    * PlasmaGlucose
    * DiastolicBloodPressure
    * TricepsThickness
    * SerumInsulin
    * BMI
    * DiabetesPedigree

    **注**: 数値列を正規化して同じスケールにし、大きい値を含む列がモデルのトレーニングに大きな影響を及ぼさないようにしています。 通常、このような前処理変換の全体を適用して、トレーニング用のデータを準備しますが、この演習では簡単な作業を行います。

4. これで、トレーニングと検証のためにデータを個別のデータセットに分割する準備ができました。 左側のペインの **[Data Transformations]\(データ変換\)** セクションで、**[Split Data]\(データの分割\)** モジュールをキャンバスの **[Normalize Data]\(データの正規化\)** モジュールの下にドラッグします。 次に、**[Normalize Data]\(データの正規化\)** モジュールの "*変換されたデータセット*" (左側) の出力を、**[Split Data]\(データの分割\)** モジュールの入力に接続します。
5. **[データの分割]** モジュールを選択し、その設定を次のように構成します。
    * **分割モード** 行の分割
    * **最初の出力データセット内の行の割合**:0.7
    * **[ランダム シード]**: 123
    * **[Stratified split]\(層化分割\)**: False

## <a name="add-model-training-modules"></a>モデル トレーニング モジュールを追加する

データを準備し、トレーニング データセットと検証データセットに分割したら、パイプラインを構成してモデルをトレーニングおよび評価する準備が整います。

1. 左側のペインにある **[Model Training]\(モデル トレーニング\)** セクションを展開し、**[モデルのトレーニング]** モジュールをキャンバスの **[データの分割]** モジュールの下にドラッグします。 次に、**[データの分割]** モジュールの "*結果データセット 1*" (左側) の出力を **[モデルのトレーニング]** モジュールの "*データセット*" (右側) の入力に接続します。
2. トレーニングするモデルでは **Diabetic** の値が予測されるため、**[モデルのトレーニング]** モジュールを選択し、**ラベル列** を **Diabetic** に設定するように設定を変更します (大文字と小文字の区別とスペルは正確に一致させます)。
3. モデルが予測する **糖尿病** ラベルはバイナリ列 (糖尿病患者の場合は 1、そうでない患者の場合は 0) であるため、"*分類*" アルゴリズムを使用してモデルをトレーニングする必要があります。 **[Machine Learning Algorithms]\(機械学習アルゴリズム\)** セクションを展開し、**[分類]** の下で、**[Two-Class Logistic Regression]\(2 クラス ロジスティック回帰\)** モジュールをキャンバスの **[データの分割]** モジュールの左、**[モデルのトレーニング]** モジュールの上にドラッグします。 次に、その出力を、**[モデルのトレーニング]** モジュールの **Untrained model** (左側) の入力に接続します。
4. トレーニング済みモデルをテストするには、元のデータを分割するときに元に戻した検証データセットをスコアリングするために使用する必要があります。 **[Model Scoring & Evaluation]\(モデル スコアリングおよび評価\)** セクションを展開し、**[Score Model]\(モデルのスコア付け\)** モジュールをキャンバスの **[モデルのトレーニング]** モジュールの下にドラッグします。 次に、**[モデルのトレーニング]** モジュールの出力を、**[Score Model]\(モデルのスコア付け\)** モジュールの **トレーニング済みモデル** (左側) の入力に接続します。**[データの分割]** モジュールの **結果データセット 2** (右側) の出力を、**[Score Model]\(モデルのスコア付け\)** モジュールの **データセット** (右側) の入力にドラッグします。
5. モデルのパフォーマンスを評価するには、検証データセットのスコアリングによって生成されるメトリックを調べる必要があります。 **モデルのスコアリングと評価** セクションから、**モデルのスコアリング** モジュールの下のキャンバスに **モデルの評価** モジュールをドラッグし、**モデルのスコアリング** モジュールの出力を **モデルの評価** モジュールの **データセットのスコアリング** (左) 入力に接続します。

## <a name="run-the-training-pipeline"></a>トレーニング パイプラインを実行する

データ フロー ステップを定義したら、トレーニング パイプラインを実行してモデルをトレーニングする準備が整います。

1. パイプラインが以下のようになっていることを確認します。

    ![ビジュアル トレーニング パイプライン](images/visual-training.jpg)

2. 右上の **[送信]** をクリックします。 次に、ダイアログが表示されたら、**mslearn-designer-train-diabetes** という名前の新しい実験を作成し、実行します。  これにより、コンピューティング クラスターが初期化され、パイプラインが実行されます。実行には 10 分以上かかる場合があります。 デザイン キャンバスの右上で、パイプライン実行の状態を確認できます。

    > **ヒント**: **GraphDatasetNotFound** エラーが発生した場合は、データセットを選択し、その [プロパティ] ペインで **バージョン** を変更して ([常に最新のものを使用する] か [1] に切り替えられます)、パイプラインを再び実行します。
    >
    > 実行中は、 **[パイプライン]** および **[実験]** ページで作成されたパイプラインと実験を表示できます。 完了したら、 **[デザイナー]** ページの **Visual Diabetes Training** パイプラインに切り替えます。

3. **データの正規化** モジュールが完了したら、このモジュールを選択し、 **[設定]** ウィンドウの **[出力 + ログ]** タブを開き、 **[変換済みデータセット]** セクションの **[データ出力]** で、 **[データのプレビュー]** アイコンをクリックします。変換された列の統計情報と分布の視覚化が表示されていることに注目してください。
4. **[データの正規化の視覚化]** を閉じ、残りのモジュールが完了するまで待ちます。 次に、**モデルの評価** モジュールの出力を視覚化して、モデルのパフォーマンス メトリックを確認します。

    **注**: このモデルのパフォーマンスは、最小限の特徴エンジニアリングと前処理のみを実行したため、パフォーマンスが非常に高いとは言えません。 いくつかの異なる分類アルゴリズムを試して結果を比較することができます (**データ分割** モジュールの出力を複数の **モデルのトレーニング** モジュールと **モデルのスコアリング** モジュールに接続し、2 番目にスコアリングしたモデルを **モデルの評価** モジュールに接続して並べて比較できます)。 演習のポイントは、完璧なモデルをトレーニングすることではなく、単にデザイナーのインターフェイスを紹介することです。

## <a name="create-an-inference-pipeline"></a>推論パイプラインを作成する

"*トレーニング パイプライン*" を使用してモデルをトレーニングしたので、トレーニング済みモデルを使用して新しいデータのラベルを予測する "*推論パイプライン*" を作成できます。

1. **[Create inference pipeline]\(推論パイプラインの作成\)** ドロップダウン リストで、**[Real-time inference pipeline]\(リアルタイム推論パイプライン\)** をクリックします。 数秒後に、**Visual Diabetes Training - リアルタイム推論** という名前のパイプラインの新しいバージョンが開きます。
2. 新しいパイプラインの名前を **Predict Diabetes** に変更し、新しいパイプラインを確認します。 正規化の変換とトレーニング済みモデルはこのパイプラインにカプセル化されているため、新しいデータ値の正規化にはトレーニング データからの統計情報が使用され、新しいデータのスコア付けにはトレーニング済みモデルが使用されます。
3. 推論パイプラインでは、新しいデータが元のトレーニング データのスキーマと一致するものと仮定されるため、トレーニング パイプラインの **糖尿病データセット** データセットが含まれていることにご注意ください。 ただし、この入力データには、モデルによって予測される **Diabetic** ラベルが含まれています。これは、糖尿病予測がまだ行われていない新しい患者データに含めるには非直感的です。
4. この **糖尿病データセット** データセットを推論パイプラインから削除し、 **[データの入力と出力]** セクションの **データの手動入力** モジュールに置き換えます。これにより、**Web サービス入力** と同じように、**変換の適用** モジュールの同じ **データセット** 入力に接続します。 次に、**データの手動入力** モジュールの設定を変更し、3 つの新しい患者観察用ラベルのない特徴値を含む次の CSV 入力を使用します。

```CSV
PatientID,Pregnancies,PlasmaGlucose,DiastolicBloodPressure,TricepsThickness,SerumInsulin,BMI,DiabetesPedigree,Age
1882185,9,104,51,7,24,27.36983156,1.350472047,43
1662484,6,73,61,35,24,18.74367404,1.074147566,75
1228510,4,115,50,29,243,34.69215364,0.741159926,59
```

5. 推論パイプラインには **[Evaluate Mode]\(モデル評価\)** モジュールが含まれていますが、このモジュールは、新しいデータから予測するときには役に立たないため削除します。
6. **[Score Model]\(モデルのスコア付け\)** モジュールからの出力には、すべての入力の特徴に加え、予測ラベルと確率スコアが含まれています。 出力を予測と確率だけに制限するには、**モデルのスコアリング** モジュールと **Web サービス出力** の間の接続を削除し、 **[Python 言語]** セクションから **Python スクリプトの実行** モジュールを追加し、**モデルのスコアリング** モジュールからの出力を **Python スクリプトの実行** の **Dataset1** (左端) の入力に接続し、**Python スクリプト実行** モジュールの出力を **Web サービス出力** に接続します。 次に、以下のコードを使用して、**Python スクリプトの実行** モジュールの設定を変更します (既存のコードをすべて置き換えます)。

```Python
import pandas as pd

def azureml_main(dataframe1 = None, dataframe2 = None):

    scored_results = dataframe1[['PatientID', 'Scored Labels', 'Scored Probabilities']]
    scored_results.rename(columns={'Scored Labels':'DiabetesPrediction',
                                    'Scored Probabilities':'Probability'},
                            inplace=True)
    return scored_results
```
> **注**: **Execute Python Script** モジュールにコードを貼り付けた後、コードが上記のコードのようになっていることを確認します。 Python ではインデントが重要であり、インデントが正しくコピーされていないとモジュールは失敗します。 

7. パイプラインが以下のようになっていることを確認します。

    ![ビジュアル推論パイプライン](images/visual-inference.jpg)

9. トレーニングに使用したコンピューティング クラスターで、**mslearn-designer-predict-diabetes** という名前の新しい実験としてパイプラインを送信します。 これには時間がかかる場合があります。

## <a name="deploy-the-inference-pipeline-as-a-web-service"></a>Web サービスとして推論パイプラインをデプロイする

これで、リアルタイム推論のための推論パイプラインが作成され、クライアント アプリケーションが使用する Web サービスとしてデプロイできます。

> **注**:この演習では、Azure コンテナー インスタンス (ACI) に Web サービスをデプロイします。 この種類のコンピューティングは、動的に作成され、開発とテストに役立ちます。 運用環境では、"*推論クラスター*" を作成する必要があります。これにより、スケーラビリティとセキュリティを向上させる Azure Kubernetes Service (AKS) クラスターが提供されます。

1. **糖尿病の予測** 推論パイプラインの実行がまだ完了していない場合は、完了を待ちます。 次に、**Python スクリプトの実行** モジュールの **結果データセット** 出力を視覚化して、入力データ内の 3 人の患者観察の予測ラベルと確率を確認します。
2. 右上の **[デプロイ]** をクリックし、次の設定を使用して新しいリアルタイム エンドポイントをデプロイします。
    -  **名前**: designer-predict-diabetes
    -  **説明**: 糖尿病の予測。
    - **[コンピューティングの種類]**: Azure コンテナー インスタンス
3. Web サービスがデプロイされるまで待ちます。これには数分かかることがあります。 デプロイの状態は、デザイナー インターフェイスの左上に表示されます。

## <a name="test-the-web-service"></a>Web サービスをテストする

これで、クライアント アプリケーションからデプロイ済みのサービスをテストできます。この場合、ノートブックを使用します。

1. **[エンドポイント]** ページで、**designer-predict-diabetes** のリアルタイム エンドポイントを開きます。
2. **designer-predict-diabetes** エンドポイントが開いたら、 **[使用]** タブで、**REST** エンドポイントと **主キー** の値をメモします。
3. ブラウザーに **designer-predict-diabetes** サービス ページの **[使用]** ページが開いた状態で、新しいブラウザー タブを開き、Azure Machine Learning スタジオの 2 番目のインスタンスを開きます。 次に、新規タブで **[ノートブック]** ページを表示します。
4. **ノートブック** ページの **[マイ ファイル]** で、ノートブック リポジトリを複製した **/users/*your-user-name*/mslearn-dp100** フォルダーを参照し、**デザイナー予測を取得する** ノートブックを開きます。
5. ノートブックが開いたら、前に作成したコンピューティング インスタンスが **[コンピューティング]** ボックスで選択されていること、およびその状態が **[実行中]** であることを確認します。
6. ノートブックで、**ENDPOINT** および **PRIMARY_KEY** のプレースホルダーをサービスの値に置き換えます。これは、エンドポイントのページの **[使用]** タブからコピーできます。
7. コード セルを実行し、Web サービスから返された出力を表示します。

## <a name="clean-up"></a>クリーンアップ

作成した Web サービスは "*Azure コンテナー インスタンス*" にホストされます。 それ以上実験する予定がない場合は、不要な Azure の使用が発生するのを避けるために、エンドポイントを削除する必要があります。 また、再び必要になるまでコンピューティング インスタンスを停止する必要もあります。

1. Azure Machine Learning スタジオの **[エンドポイント]** タブで、**designer-predict-diabetes** エンドポイントを選択します。 次に、 **[削除]** (&#128465;) ボタンをクリックし、エンドポイントの削除を確認します。
2. Azure Machine Learning での作業が終わったら、 **[コンピューティング インスタンス]** タブを選択し、 **[停止]** をクリックしてシャットダウンします。

> **注**: コンピューティングを停止すると、サブスクリプションがコンピューティング リソースに対して課金されなくなります。 ただし、サブスクリプションに Azure Machine Learning ワークスペースが存在する限り、データ ストレージに対して少額が課金されます。 Azure Machine Learning の探索を完了したら、Azure Machine Learning ワークスペースとそれに関連付けられたリソースを削除できます。 ただし、このシリーズの他のラボを修了する場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を繰り返して、ワークスペースを作成し、環境を準備する必要があります。
