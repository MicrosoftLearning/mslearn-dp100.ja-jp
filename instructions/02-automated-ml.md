---
lab:
  title: 自動機械学習を使用する
ms.openlocfilehash: a4908c0de74edb6c2fdf7b1a7288014d1ab86b94
ms.sourcegitcommit: 48bc4227570b0817702d195aa06fa4dabe1bbdd7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2022
ms.locfileid: "146733069"
---
# <a name="use-automated-machine-learning"></a>自動機械学習を使用する

Azure Machine Learning には、クラウド コンピューティングのスケーラビリティを活用する "*自動化機械学習*" 機能が含まれます。これにより、複数の前処理手法とモデル トレーニング アルゴリズムが並行して自動的に試行されて、データに最適なパフォーマンスの教師あり機械学習モデルが得られます。

この演習では、Azure Machine Learning Studio の自動機械学習にビジュアル インタフェイスを使用します

> **注**: Azure Machine Learning SDK を通じて自動機械学習を利用することもできます。

## <a name="before-you-start"></a>開始する前に

まだ行っていない場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を完了して、Azure Machine Learning ワークスペースとコンピューティング インスタンスを作成し、この演習に必要なノートブックのクローンを作成してください。

## <a name="configure-compute-resources"></a>コンピューティング リソースを構成する

自動機械学習を使用するには、モデル トレーニング実験を実行するための計算が必要です。

1. Azure サブスクリプションに関連付けられた Microsoft の資格情報を使用して [Azure Machine Learning スタジオ](https://ml.azure.com?azure-portal=true) にサインインし、Azure Machine Learning ワークスペースを選択します。
2. Azure Machine Learning スタジオで、 **[コンピューティング]** ページを表示し、まだ実行されていない場合は、 **[コンピューティング インスタンス]** タブでコンピューティング インスタンスを開始します。 このコンピューティング インスタンスを使用して、トレーニングされたモデルをテストします。
3. コンピューティング インスタンスが起動している間、 **[コンピューティング クラスター]** タブに切り替え、次の設定を使用して新しいコンピューティング クラスターを追加します。 このクラスターで自動機械学習の実験を実行し、トレーニングの実行を複数のコンピューティング ノードに分散する機能を利用します。
    - **場所**: "*ワークスペースと同じ場所*"
    - **仮想マシンのレベル**: 専用
    - **[仮想マシンのタイプ]**:CPU
    - **[仮想マシンのサイズ]**: Standard_DS11_v2
    - **[コンピューティング名]**: "*一意の名前を入力します*"
    - **[ノードの最小数]**: 0
    - **[ノードの最大数]**:2
    - **[スケール ダウンする前のアイドル時間 (秒)]**:120
    - **[Enable SSH access]\(SSH アクセスの有効化\)**: 未選択

## <a name="create-a-dataset"></a>データセットを作成する

データの処理に使用できるコンピューティング リソースがいくつかできたので、処理するデータを格納および取り込む方法が必要になります。

1. Web ブラウザーで、https://aka.ms/diabetes-data のコンマ区切りデータを表示します。 次に、これを **diabetes.csv** という名前のローカル ファイルとして保存します (どこに保存しても問題はありません)。
2. Azure Machine Learning スタジオで、 **[データ]** ページを表示します。 データセットは、Azure ML 内で使用する予定の特定のデータ ファイルまたはテーブルを表します。
3. 次の設定を使用して、ローカル ファイルから新しいデータセットを作成します。
    * **[基本情報]**:
        * **名前**: 糖尿病データセット
        * **データセットの種類**:表形式
        * **説明**:糖尿病データ
    * **データストアとファイルの選択**:
        * **データストアの選択または作成**: 現在選択されているデータストア
        * **データセット用のファイルの選択**: ダウンロードした **diabetes.csv** ファイルを参照します。
        * **アップロード パス**: *既定の選択のままにします*。
        * **データ検証のスキップ**: 選択されていません
    * **設定とプレビュー**:
        * **[ファイル形式]**: 区切り記号付き
        * **[区切り記号]**: コンマ
        * **[エンコード]**: UTF-8
        * **[列ヘッダー]**: 最初のファイルにのみヘッダーを付ける
        * **[行のスキップ]**: なし
    * **[スキーマ]**:
        * **[パス]** 以外のすべての列を含める
        * 自動的に検出された型を確認する
    * **[詳細の確認]**:
        * 作成後にデータセットをプロファイリングしない
4. データセットが作成されたら、それを開き、**[探索]** ページを表示して、データのサンプルを確認します。 このデータは、糖尿病の検査を受けた患者の詳細を表しています。臨床的な測定値に基づいて、患者が糖尿病で陽性と判定される可能性を予測するモデルをトレーニングするために使用します。

    > **注**: 必要に応じて、データセットの "*プロファイル*" を生成して、より詳細な統計情報を表示できます。

## <a name="run-an-automated-machine-learning-experiment"></a>自動機械学習の実験を実行する

Azure Machine Learning では、実行する操作は "*実験*" と呼ばれます。 次の手順に従って、自動機械学習を使用して糖尿病の診断を予測する分類モデルをトレーニングする実験を実行します。

1. Azure Machine Learning スタジオで、 **[自動 ML]** ページ ( **[作成者]** の下) を表示します。
2. 次の設定を使用して、新しい自動 ML 実行を作成します。
    - **[データセットの選択]**:
        - **データセット**: 糖尿病データセット
    - **[構成の実行]**:
        - **新しい実験名**: mslearn-automl-diabetes
        - **ターゲット列**: 糖尿病 ("*モデルが予測するためにトレーニングされるラベル*")
        - **コンピューティングの種類の選択**: コンピューティング クラスター
        - **Azure ML コンピューティング クラスターの選択**: "*前に作成したコンピューティング クラスター*"
    - **[Task type and settings]\(タスクの種類と設定\)**:
        - **タスクの種類**: 分類
        - **[追加の構成設定を表示する]** を選択して、 **[追加の構成]** を開きます。
            - **[Primary metric]\(プライマリ メトリック\)** : **AUC Weighted** を選択 *(このメトリックについては後ほど詳しく説明します。)*
            - **[Explain best model]\(最適なモデルの説明\)**: オン - "*このオプションを選択すると、自動機械学習によって最適なモデルの特徴の重要度が計算されます。これにより、予測されたラベルの各特徴の影響を判断できます。*"
            - **サポートされているすべてのモデルを使用する**:<u>未</u>選択 - いくつかの特定のアルゴリズムだけを試すように実験を制限します。
            - **許可されたモデル**:**LogisticRegression** と **RandomForest** のみを選択します。 これらは、実験で試された唯一のアルゴリズムになります。
            - **[Exit criterion]\(終了条件\)**:
                - **[Training job time (hours)]\(トレーニング ジョブ時間 (時間単位)\)**: 0.5 - *最大で 30 分後に実験が終了します。*
                - **メトリック スコアしきい値**: 0.90 - "*モデルの重み付き AUC メトリックが 90% 以上になると実験は終了します。* "
        - **[特徴量化の設定を表示する]** を選択して **[特徴量化]** を開きます。
            - **[Enable featurization]\(特徴量化を有効にする\)**:オン - "*これにより、Azure Machine Learning によってトレーニングの前に特徴量が自動的に前処理されます。*"
    - **検証とテストの種類を選択**:
        - **検証の種類**: トレーニング検証の分割
        - **データの検証の割合**: 30
        - **テスト データセット**: テスト データセットは必要ありません

3. 自動 ML 実行の詳細の送信が完了すると、自動的に開始されます。 実行の状態は **[プロパティ]** ペインで確認できます。
4. 実行状態が "*[実行中]*" に変わったら、**[モデル]** タブを表示し、トレーニング アルゴリズムと前処理手順の各組み合わせが試行され、生成されたモデルのパフォーマンスが評価されることを確認します。 このページは定期的に自動的に更新されますが、**[&#8635; 更新]** を選択することもできます。 トレーニングを開始する前にクラスター ノードを初期化し、データの特徴量化プロセスを完了させる必要があるため、モデルの表示が開始されるまで 10 分ほどかかることがあります。 コーヒーでも飲んで待ちましょう。
5. 実験が完了するまで待ちます。

## <a name="review-the-best-model"></a>最高のモデルを確認する

実験が終了したら、生成された最適なパフォーマンス モデルを確認できます (この例では、終了条件を使用して実験を停止しました。そのため、実験によって得られた "最適な" モデルは、実際に最適なモデルではなく、この演習で許可されている期間とメトリックの制約内で最も適しているにすぎない可能性があります)。

1. 自動機械学習の実行の **[概要]** タブで、最適なモデルの概要を確認します。
2. 最適なモデルの **[アルゴリズム名]** を選択して、そのモデルを生成した子実行を表示します。

    最適なモデルは、指定した評価メトリック (*AUC_Weighted*) に基づいて識別されます。 このメトリックを計算するために、トレーニング プロセスでは、一部のデータを使用してモデルをトレーニングし、"*クロス検証*" と呼ばれる手法を適用して、トレーニング済みのモデルを、トレーニングに使用されていないデータで反復的にテストし、予測値を実際の既知の値と比較しました。 これらの比較から、真陽性、偽陽性、真陰性、偽陰性の "*混同行列*" が表になり、真陽性率と偽陽性率を比較する受信者操作特性 (ROC) 曲線グラフを含む追加の分類メトリクスが計算されます。 この曲線下面積 (AUC) は、分類パフォーマンスを評価するために使用される一般的なメトリックです。
3. *AUC_Weighted* 値の横にある **[他のすべてのメトリックを表示]** を選択して、分類モデルで使用可能な他の評価メトリックの値を表示します。
4. **[メトリック]** タブを選択し、モデルについて表示できるパフォーマンス メトリックを確認します。 これらには、検証済みモデルの混同行列を示す **confusion_matrix** 視覚化と、ROC グラフを含む **accuracy_table** 視覚化が含まれます。
5. **[説明]** タブを選択し、 **[説明 ID]** を選択して、 **[重要度の集計]** ページを表示します。 これは、データセット内の各特徴がラベル予測にどの程度影響を与えるかを示しています。

## <a name="deploy-a-predictive-service"></a>予測サービスをデプロイする

自動機械学習を使用していくつかのモデルをトレーニングした後は、クライアント アプリケーションで使用するサービスとして最適なモデルをデプロイできます。

> **注**: Azure Machine Learning では、サービスを Azure Container Instances (ACI) として、または Azure Kubernetes Service (AKS) クラスターにデプロイできます。 運用環境のシナリオでは、AKS のデプロイをお勧めします。その場合、*推論クラスター* コンピューティング ターゲットを作成する必要があります。 この演習では、テストに適したデプロイ ターゲットである ACI サービスを使用します。また、推論クラスターを作成する必要はありません。

1. 最適なモデルを生成した実行の **[概要]** タブを選択します。
2. **[デプロイ]** オプションで、 **[Web サービスにデプロイ]** ボタンを使用して、次の設定でモデルをデプロイします。
    - **名前**: auto-predict-diabetes
    - **説明**:糖尿病の予測
    - **[コンピューティングの種類]**: Azure コンテナー インスタンス
    - **[認証を有効にする]**: オン
    - **カスタム デプロイ アセットを使用する**: 未選択
3. デプロイが開始するのを待ちます。これには数秒かかることがあります。 次に、 **[モデル]** タブの **[モデルの概要]** セクションで、**auto-predict-diabetes** サービスの **[デプロイの状態]** が **[実行中]** になっていることを確認します。 この状態が **[成功]** に変わるまで待ちます。 **[&#8635; 更新]** を定期的に選択する必要があります。  **注**: これには時間がかかる場合があります。
4. Azure Machine Learning スタジオの **[エンドポイント]** ページを表示し、**auto-predict-diabetes** リアルタイム エンドポイントを選択します。 次に、**[消費]** タブを選択し、次の情報を確認します。 この情報は、クライアント アプリケーションからデプロイ済みのサービスに接続するために必要です。
    - サービスの REST エンドポイント
    - サービスの主キー
5. 横にある &#10697; リンクを使用して、これらの値をクリップボードにコピーできることに注意してください。

## <a name="test-the-deployed-service"></a>デプロイされたサービスをテストする

サービスをデプロイしたので、いくつかの単純なコードを使用してテストできます。

1. ブラウザーに **[auto-predict-diabetes サービス]** ページの **[使用]** ページが開いた状態で、新しいブラウザー タブを開き、Azure Machine Learning スタジオの 2 番目のインスタンスを開きます。 次に、新規タブで **[ノートブック]** ページを表示します。
2. **ノートブック** ページの **[マイ ファイル]** で、ノートブック リポジトリを複製した **/users/*your-user-name*/mslearn-dp100** フォルダーを参照し、**AutoML 予測を取得する** ノートブックを開きます。
3. ノートブックが開いたら、前に作成したコンピューティング インスタンスが **[コンピューティング]** ボックスで選択されていること、およびその状態が **[実行中]** であることを確認します。
4. ノートブックで、**ENDPOINT** および **PRIMARY_KEY** のプレースホルダーをサービスの値に置き換えます。これは、エンドポイントのページの **[使用]** タブからコピーできます。
5. コード セルを実行し、Web サービスから返された出力を表示します。

## <a name="clean-up"></a>クリーンアップ

作成した Web サービスは "*Azure コンテナー インスタンス*" にホストされます。 それ以上実験する予定がない場合は、不要な Azure の使用が発生するのを避けるために、エンドポイントを削除する必要があります。 また、再び必要になるまでコンピューティング インスタンスを停止する必要もあります。

1. Azure Machine Learning スタジオの **[エンドポイント]** タブで、**auto-predict-diabetes** エンドポイントを選択します。 次に、**[削除]** (&#128465;) を選択し、エンドポイントを削除することを確認します。
2. **[コンピューティング]** ページの **[Compute Instances]\(コンピューティング インスタンス\)** タブで、コンピューティング インスタンスを選択し、**[停止]** を選択します。

> **注**: コンピューティングを停止すると、サブスクリプションがコンピューティング リソースに対して課金されなくなります。 ただし、サブスクリプションに Azure Machine Learning ワークスペースが存在する限り、データ ストレージに対して少額が課金されます。 Azure Machine Learning の探索を完了したら、Azure Machine Learning ワークスペースとそれに関連付けられたリソースを削除できます。 ただし、このシリーズの他のラボを修了する場合は、" *[Azure Machine Learning ワークスペースを作成する](01-create-a-workspace.md)* " 演習を繰り返して、ワークスペースを作成し、環境を準備する必要があります。
